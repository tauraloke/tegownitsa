<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Electron boilerplate</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<script>
		// Front layer
		const CAPTION_NOT_FOUND = "[NO CAPTION FOUND]";

		function showActionStroke(message) {
			console.log("STATE: ", message);
			document.getElementById("actionStroke").textContent = message;
		}
		function showTags(tags) {
			document.getElementById("tags").innerHTML = "";
			tags.forEach((tag) => {
				let p = document.createElement("p");
				p.setAttribute("data-id", tag["id"]);
				let title = Object.values(tag["locales"]).join(" / ");
				p.innerHTML = `<a>${title}</a>`;
				document.getElementById("tags").appendChild(p);
			});
		}
		function showFiles(files) {
			document.getElementById("files").innerHTML = "";
			files.forEach((file) => {
				let div = document.createElement("div");
				div.setAttribute("data-id", file["id"]);
				div.className = "gallery_block"; //TODO: спорно, нужно отладить
				div.innerHTML = `<img src='${file["fullpath"]}' /><p class='filename'>${file["source_filename"]}</p>`;
				document.getElementById("files").appendChild(div);
			});
		}
		function searchString() {
			return document.getElementById("search_string").value;
		}
		async function searchFilesByTag() {
			showActionStroke(`Start search by tag`);
			let tag_title = searchString();
			let files = await window.sqliteApi.findFilesByTag(tag_title);
			showFiles(files);
			showActionStroke(`Found ${files.length} results by tag '${tag_title}'`);
		}
		async function searchFilesByCaption() {
			let caption = searchString();
			showActionStroke(`Start search by caption '${caption}'`);
			let files = await window.sqliteApi.queryAll(
				"SELECT * FROM files WHERE INSTR(caption, ?)",
				[caption]
			);
			showFiles(files);
			showActionStroke(`Found ${files.length} results by caption '${caption}'`);
		}
		async function showFileInfo() {
			document.getElementById("file_info").innerHTML = "";
			//TODO: write body
		}

		async function searchFilesByTagId(event) {
			showActionStroke(`Start search by tag id`);
			if (event.path && event.path[0] && event.path[0].tagName == "A") {
				let tag_id = event.path[0].getAttribute("data-id");
				let files = await window.sqliteApi.findFilesByTagId(tag_id);
				showFiles(files);
				showActionStroke(`Found ${files.length} results by tag id ${tag_id}`);
			}
		}

		// TODO: use and remove
		async function ajaxQuery() {
			await window.sqliteApi.ajax();
		}
		async function openFolder(event) {
			let folder = await window.fileApi.openFolder();
			if (!(folder && folder.filePaths && folder.filePaths[0])) return false;
			let path = folder.filePaths[0];
			console.log(`Loading folder ${path}`);
			window.fileApi.addFilesFromFolder(path);
			showActionStroke(`Folder ${path} has imported.`);
		}
		async function openFile(event) {
			let file = await window.fileApi.openFile();
			if (!(file && file.filePaths && file.filePaths[0])) {
				return false;
			}
			let path = file.filePaths[0];
			console.log(`Chosen file ${path}`);
			await window.fileApi.addFile(path);
			showActionStroke(`File ${path} has imported.`);
		}
		async function importFromClipboard() {
			const tmpFilePath = await window.fileApi.saveTempFileFromClipboard();
			if (!tmpFilePath) {
				showActionStroke(`Clipboard is empty.`);
				return false;
			}
			await window.fileApi.addFile(tmpFilePath);
			await window.fileApi.removeFile(tmpFilePath);
			showActionStroke(`File has imported from a clipboard.`);
		}
		async function showAllTags() {
			showTags(await window.sqliteApi.getAllTags());
		}
		async function findFilesByTag(file_id) {
			showTags(await window.sqliteApi.findFilesByTag(file_id));
		}
		async function scanStorage() {
			let files = await window.sqliteApi.queryAll("SELECT * FROM files;");
			for (index in files) {
				let file = files[index];
				if (window.sqliteApi.fileIsNotScanned(file)) {
					try {
						console.log("Scan file: ", file);
						let recognized = await window.ocrApi.recognize(file["fullpath"], [
							"eng",
							"rus",
							"jpn",
						]); // TODO: move languages to app settings
						console.log("Recognized: ", recognized);
						let caption = recognized.data.blocks
							.filter((b) => b.text.trim() != "" && b.confidence > 70)
							.map((b) => b.text.replace(/[\n\t\r]/g, " "))
							.join("\n");
						if (caption == "") {
							caption = CAPTION_NOT_FOUND;
						}
						console.log(`#${file["id"]}: Scanned text: ${caption}`);
						await window.sqliteApi.query(
							"UPDATE files SET caption=? WHERE id=?;",
							[caption, file["id"]]
						);
					} catch (e) {
						console.error(e);
					}
				}
			}
		}
	</script>
	<body>
		<div class="container">
			<header>
				<button onclick="sqlQuery()">SQLite</button>
				<button onclick="ajaxQuery()">Ajax</button>
				<button onclick="openFolder()">Import folder</button>
				<button onclick="openFile()">Import file</button>
				<button onclick="importFromClipboard()">Import from clipboard</button>
				<button onclick="scanStorage()">Scan storage</button>
				<button onclick="showAllTags()">Show all tags</button>
				<div id="search_form">
					<input type="text" id="search_string" />
					Find
					<button onclick="searchFilesByTag()">by tag</button>
					<button onclick="searchFilesByCaption()">by captions</button>
				</div>
			</header>
			<section class="main">
				<div id="tags" onclick="searchFilesByTagId(event)"></div>
				<div id="files" onclick="showFileInfo(event)"></div>
				<div id="file_info"></div>
			</section>
			<footer>
				<div id="actionStroke"></div>
			</footer>
		</div>
	</body>
</html>
