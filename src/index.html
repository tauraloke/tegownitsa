<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Electron boilerplate</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<script>
		// Front layer
		const CAPTION_NOT_FOUND = "[NO CAPTION FOUND]";
		let files = [];
		let currentFile = null;
		let tags = [];

		function showActionStroke(message) {
			console.log("STATE: ", message);
			document.getElementById("actionStroke").textContent = message;
		}
		function showTags(_tags) {
			document.getElementById("tags").innerHTML = "";
			_tags.forEach((tag) => {
				let p = document.createElement("p");
				p.setAttribute("data-id", tag["id"]);
				let title = Object.values(tag["locales"]).join(" / ");
				p.innerHTML = `<a>${title}</a>`;
				document.getElementById("tags").appendChild(p);
			});
			tags = _tags;
		}
		function showFiles(_files) {
			document.getElementById("files").innerHTML = "";
			_files.forEach((file) => {
				let div = document.createElement("div");
				div.setAttribute("data-id", file["id"]);
				div.className = "gallery_block";
				div.innerHTML = `<img src='${file["fullpath"]}' /><p class='filename'>${file["source_filename"]}</p>`;
				document.getElementById("files").appendChild(div);
			});
			files = _files;
		}
		function showFileInfo(file) {
			document.getElementById("file_info").style.display = "none";
			document.getElementById("file_info_header").innerHTML =
				file["source_filename"];
			document.getElementById("file_info_img").src = file["fullpath"];
			document.getElementById(
				"file_info_caption_container"
			).innerHTML = `<textarea id="file_info_caption">${file["caption"]}</textarea>`;
			document.getElementById("file_info").style.display = "block";
			currentFile = file;
		}
		function hideFileInfo() {
			document.getElementById("file_info").style.display = "none";
			currentFile = null;
		}

		function searchString() {
			return document.getElementById("search_string").value;
		}
		async function searchFilesByTag() {
			hideFileInfo();
			showActionStroke(`Start search by tag`);
			let tag_title = searchString();
			let files = await window.sqliteApi.findFilesByTag(tag_title);
			showFiles(files);
			showActionStroke(`Found ${files.length} results by tag '${tag_title}'`);
		}
		async function searchFilesByCaption() {
			hideFileInfo();
			let caption = searchString();
			showActionStroke(`Start search by caption '${caption}'`);
			let files = await window.sqliteApi.queryAll(
				"SELECT * FROM files WHERE caption LIKE '%' || ? || '%'",
				[caption]
			);
			showFiles(files);
			showActionStroke(`Found ${files.length} results by caption '${caption}'`);
		}
		async function filesClick(event) {
			let block = event.path.find((b) => b.className == "gallery_block");
			if (!block) {
				return false;
			}
			let file_id = parseInt(block.getAttribute("data-id"));
			file = files.find((f) => f["id"] == file_id);
			showFileInfo(file);
			await findFilesByTag(file_id);
		}

		async function searchFilesByTagId(event) {
			showActionStroke(`Start search by tag id`);
			if (event.path && event.path[0] && event.path[0].tagName == "A") {
				let tag_id = event.path[0].getAttribute("data-id");
				let files = await window.sqliteApi.findFilesByTagId(tag_id);
				showFiles(files);
				showActionStroke(`Found ${files.length} results by tag id ${tag_id}`);
			}
		}
		async function updateCaption() {
			if (!currentFile || !currentFile["id"]) {
				showActionStroke("Have no current file!");
				return false;
			}
			let newCaption = document.getElementById("file_info_caption").value;
			currentFile["caption"] = newCaption;
			await window.sqliteApi.query("UPDATE files SET caption=? WHERE id=?", [
				newCaption,
				currentFile["id"],
			]);
			showActionStroke(`Caption updated for file #${file["id"]}`);
		}

		async function openFolder(event) {
			let folder = await window.fileApi.openFolder();
			if (!(folder && folder.filePaths && folder.filePaths[0])) return false;
			let path = folder.filePaths[0];
			console.log(`Loading folder ${path}`);
			window.fileApi.addFilesFromFolder(path);
			showActionStroke(`Folder ${path} has imported.`);
		}
		async function openFile(event) {
			let file = await window.fileApi.openFile();
			if (!(file && file.filePaths && file.filePaths[0])) {
				return false;
			}
			let path = file.filePaths[0];
			console.log(`Chosen file ${path}`);
			await window.fileApi.addFile(path);
			showActionStroke(`File ${path} has imported.`);
		}
		async function importFromClipboard() {
			const tmpFilePath = await window.fileApi.saveTempFileFromClipboard();
			if (!tmpFilePath) {
				showActionStroke(`Clipboard is empty.`);
				return false;
			}
			await window.fileApi.addFile(tmpFilePath);
			await window.fileApi.removeFile(tmpFilePath);
			showActionStroke(`File has imported from a clipboard.`);
		}
		async function showAllTags() {
			showTags(await window.sqliteApi.getAllTags());
		}
		async function findFilesByTag(file_id) {
			showTags(await window.sqliteApi.findFilesByTag(file_id));
		}
		async function scanStorage() {
			let files = await window.sqliteApi.queryAll("SELECT * FROM files;");
			for (index in files) {
				let file = files[index];
				if (window.sqliteApi.fileIsNotScanned(file)) {
					try {
						console.log("Scan file: ", file);
						let recognized = await window.ocrApi.recognize(file["fullpath"], [
							"eng",
							"rus",
							"jpn",
						]); // TODO: move languages to app settings
						console.log("Recognized: ", recognized);
						let caption = recognized.data.blocks
							.filter((b) => b.text.trim() != "" && b.confidence > 70)
							.map((b) => b.text.replace(/[\n\t\r]/g, " "))
							.join("\n");
						if (caption == "") {
							caption = CAPTION_NOT_FOUND;
						}
						console.log(`#${file["id"]}: Scanned text: ${caption}`);
						await window.sqliteApi.query(
							"UPDATE files SET caption=? WHERE id=?;",
							[caption, file["id"]]
						);
					} catch (e) {
						console.error(e);
					}
				}
			}
		}
	</script>
	<body>
		<div class="container">
			<header>
				<button onclick="sqlQuery()">SQLite</button>
				<button onclick="openFolder()">Import folder</button>
				<button onclick="openFile()">Import file</button>
				<button onclick="importFromClipboard()">Import from clipboard</button>
				<button onclick="scanStorage()">Scan storage</button>
				<button onclick="showAllTags()">Show all tags</button>
				<div id="search_form">
					<input type="text" id="search_string" />
					Find
					<button onclick="searchFilesByTag()">by tag</button>
					<button onclick="searchFilesByCaption()">by captions</button>
				</div>
			</header>
			<section class="main">
				<div id="tags" onclick="searchFilesByTagId(event)"></div>
				<div id="files" onclick="filesClick(event)"></div>
				<div id="file_info" style="display: none">
					<div id="file_info_header"></div>
					<div id="file_info_img_container">
						<img src="" id="file_info_img" />
					</div>
					<div id="file_info_caption_container"></div>
					<div id="file_info_update_caption">
						<button onclick="updateCaption()">Update caption</button>
					</div>
				</div>
			</section>
			<footer>
				<div id="actionStroke"></div>
			</footer>
		</div>
	</body>
</html>
