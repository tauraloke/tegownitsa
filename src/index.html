<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Electron boilerplate</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<script>
		// TODO: use and remove
		async function sqlQuery() {
			console.log(window.sqliteApi);
			await window.sqliteApi.query(
				"CREATE TABLE IF NOT EXISTS users (ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,NAME TEXT NOT NULL)"
			);
			await window.sqliteApi.query(
				'INSERT INTO users ("name") values("Kiri");'
			);
			console.log(await window.sqliteApi.query("SELECT * FROM users;"));
		}
		// TODO: use and remove
		async function ajaxQuery() {
			await window.sqliteApi.ajax();
		}
		async function openFolder(event) {
			let folder = await window.fileApi.openFolder();
			if (!(folder && folder.filePaths && folder.filePaths[0])) return false;
			let path = folder.filePaths[0];
			console.log(`Loading folder ${path}`);
			window.fileApi.addFilesFromFolder(path);
			showActionStroke(`Folder ${path} has imported.`);
		}
		async function openFile(event) {
			let file = await window.fileApi.openFile();
			if (!(file && file.filePaths && file.filePaths[0])) {
				return false;
			}
			let path = file.filePaths[0];
			console.log(`Chosen file ${path}`);
			await window.fileApi.addFile(path);
			showActionStroke(`File ${path} has imported.`);
		}
		async function importFromClipboard() {
			const tmpFilePath = await window.fileApi.saveTempFileFromClipboard();
			if (!tmpFilePath) {
				showActionStroke(`Clipboard is empty.`);
				return false;
			}
			await window.fileApi.addFile(tmpFilePath);
			await window.fileApi.removeFile(tmpFilePath);
			showActionStroke(`File has imported from a clipboard.`);
		}
		function showActionStroke(message) {
			document.getElementById("actionStroke").textContent = message;
		}
		const CAPTION_NOT_FOUND = "[NO CAPTION FOUND]";
		async function scanStorage() {
			/*const result = await window.ocrApi.recognize(
				//"https://tesseract.projectnaptha.com/img/eng_bw.png",
				"/home/tauraloke/projects/rq_market/easyocr/t/__raiden_shogun_yae_miko_and_yae_miko_genshin_impact_drawn_by_beiyi__sample-9e87caaa3a0b301cd2fe3d3f6342fab3.jpg",
				["eng", "rus", "jpn"]
			);
			console.log(result);*/

			let files = await window.sqliteApi.queryAll("SELECT * FROM files;");
			for (index in files) {
				let file = files[index];
				if (window.sqliteApi.fileIsNotScanned(file)) {
					try {
						console.log("Scan file: ", file);
						let recognized = await window.ocrApi.recognize(file["fullpath"], [
							"eng",
							"rus",
							"jpn",
						]); // TODO: move languages to app settings
						console.log("Recognized: ", recognized);
						let caption = recognized.data.blocks
							.filter((b) => b.text.trim() != "" && b.confidence > 70)
							.map((b) => b.text.replace(/[\n\t\r]/g, " "))
							.join("\n");
						if (caption == "") {
							caption = CAPTION_NOT_FOUND;
						}
						console.log(`#${file["id"]}: Scanned text: ${caption}`);
						await window.sqliteApi.query(
							"UPDATE files SET caption=? WHERE id=?;",
							[caption, file["id"]]
						);
					} catch (e) {
						console.error(e);
					}
				}
			}
		}
	</script>
	<body>
		<div class="container">
			<header>
				<h1>Electron boilerplate</h1>
				<p></p>
			</header>
			<section class="main">
				test
				<button onclick="sqlQuery()">SQLite</button>
				<button onclick="ajaxQuery()">Ajax</button>
				<button onclick="openFolder()">Import folder</button>
				<button onclick="openFile()">Import file</button>
				<button onclick="importFromClipboard()">Import from clipboard</button>
				<button onclick="scanStorage()">Scan storage</button>
			</section>
			<footer>
				<div id="actionStroke"></div>
			</footer>
		</div>
	</body>
</html>
